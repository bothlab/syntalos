---
id: io.github.bothlab.syntalos
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
command: syntalos
rename-icon: syntalos
rename-desktop-file: syntalos.desktop

finish-args:
  - '--share=network'
  - '--share=ipc'
  - '--socket=x11'
  - '--socket=wayland'
  - '--device=all'
  - '--filesystem=host'
  - '--socket=system-bus'
  - '--socket=session-bus'

add-extensions:
  org.freedesktop.Platform.GL:
    directory: lib/GL
    version: '21.08'
    subdirectories: true
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d
    download-if: active-gl-driver
    enable-if: active-gl-driver

modules:
- name: essential-dirs
  buildsystem: simple
  build-commands:
    - mkdir -p /app/lib/GL

- name: opencl-headers
  buildsystem: simple
  build-commands:
    - mkdir -p /app/include/CL
    - cp -av CL/* /app/include/CL
  sources:
    - type: archive
      url: https://github.com/KhronosGroup/OpenCL-Headers/archive/refs/tags/v2022.01.04.tar.gz
      sha256: 6e716e2b13fc8d363b40a165ca75021b102f9328e2b38f8054d7db5884de29c9

- name: xxhash
  no-autogen: true
  make-install-args:
    - PREFIX=${FLATPAK_DEST}
  cleanup:
    - /bin/*
    - /lib/pkgconfig
    - /lib/*.a
    - /share
  sources:
    - type: archive
      url: https://github.com/Cyan4973/xxHash/archive/refs/tags/v0.8.1.tar.gz
      sha256: 3bb6b7d6f30c591dd65aaaff1c8b7a5b94d81687998ca9400082c739a690436c

- name: eigen3
  buildsystem: cmake-ninja
  builddir: true
  sources:
    - type: archive
      url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
      sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
  cleanup:
    - '*'

- name: svt-av1
  buildsystem: cmake-ninja
  builddir: true
  sources:
    - type: git
      url: https://gitlab.com/AOMediaCodec/SVT-AV1.git
      tag: v1.1.0

- name: libx264
  config-opts:
    - --disable-cli
    - --enable-shared
  sources:
    - type: archive
      url: https://download.videolan.org/x264/snapshots/x264-snapshot-20191217-2245-stable.tar.bz2
      sha256: b2495c8f2930167d470994b1ce02b0f4bfb24b3317ba36ba7f112e9809264160

- name: x265
  buildsystem: cmake-ninja
  builddir: true
  subdir: source
  config-opts:
    - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    - -DENABLE_CLI=OFF
  sources:
    - type: archive
      url: https://deb.debian.org/debian/pool/main/x/x265/x265_3.5.orig.tar.gz
      sha256: e70a3335cacacbba0b3a20ec6fecd6783932288ebc8163ad74bcc9606477cae8

- name: ffmpeg
  config-opts:
    - --enable-shared
    - --disable-static
    - --disable-doc
    - --disable-manpages
    - --disable-stripping
    - --disable-ffplay
    - --disable-ffprobe

    - --enable-gpl
    - --enable-version3
    - --enable-optimizations
    - --enable-postproc
    - --enable-pthreads
    - --enable-gnutls
    - --enable-libxcb-xfixes
    - --enable-opengl
    - --enable-opencl
    - --enable-sdl2
    - --enable-vaapi
    - --enable-vdpau
    - --enable-zlib
    - --enable-bzlib
    - --enable-lzma

    - --enable-fontconfig
    - --enable-libfontconfig
    - --enable-libfreetype
    - --enable-libxml2

    - --enable-avcodec
    - --enable-avfilter
    - --enable-swscale

    - --enable-libxcb
    - --enable-protocol=file

    # Codecs we need / want: FFV1, AV1, VP9, H.264, HEVC
    - --enable-libsvtav1
    - --enable-libvpx
    - --enable-libx264
    - --enable-libx265
  sources:
    - type: archive
      url: https://ffmpeg.org/releases/ffmpeg-4.4.2.tar.xz
      sha256: af419a7f88adbc56c758ab19b4c708afbcae15ef09606b82b855291f6a6faa93
  cleanup:
    - /share/ffmpeg/examples

- name: toml++
  buildsystem: meson
  builddir: true
  sources:
    - type: archive
      url: https://github.com/marzer/tomlplusplus/archive/refs/tags/v3.0.1.tar.gz
      sha256: e05b2814b891e223d7546aa2408d6cba0628164a84ac453205c7743cb667b9cf

- name: opencv
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
    - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    - -DOPENCV_GENERATE_PKGCONFIG=ON
    - -DWITH_OPENCL=ON
    - -DWITH_OPENGL=ON
    - -DWITH_TBB=ON
    - -DWITH_VULKAN=ON
    - -DBUILD_WITH_DEBUG_INFO=OFF
    - -DBUILD_TESTS=OFF
    - -DBUILD_PERF_TESTS=OFF
    - -DBUILD_EXAMPLES=OFF
    - -DINSTALL_C_EXAMPLES=OFF
    - -DINSTALL_PYTHON_EXAMPLES=OFF
    # - -DOPENCV_EXTRA_MODULES_PATH="contrib/modules"
    - -DWITH_1394=OFF
    - -DWITH_PROTOBUF=ON
    - -DBUILD_LIST=calib3d,core,dnn,features2d,flann,highgui,imgcodecs,imgproc,java_bindings_generator,ml,objdetect,photo,python_bindings_generator,python_tests,stitching,video,videoio
  # cleanup:
  #   - "/bin"
  sources:
    - type: archive
      url: https://github.com/opencv/opencv/archive/refs/tags/4.5.5.tar.gz
      sha256: a1cfdcf6619387ca9e232687504da996aaa9f7b5689986b8331ec02cb61d28ad
    - type: archive
      url: https://github.com/opencv/opencv_contrib/archive/refs/tags/4.5.5.tar.gz
      sha256: a97c2eaecf7a23c6dbd119a609c6d7fae903e5f9ff5f1fe678933e01c67a6c11

- name: libusb
  sources:
    - type: archive
      url: https://github.com/libusb/libusb/archive/v1.0.24.tar.gz
      sha256: b7724c272dfc5713dce88ff717efd60f021ca5b7c8e30f08ebb2c42d2eea08ae

- name: pybind11
  buildsystem: simple
  build-commands:
    - python3 setup.py build
    - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF -DCMAKE_INSTALL_INCLUDEDIR:PATH=${FLATPAK_DEST}/include
      -DCMAKE_INSTALL_LIBDIR:PATH=${FLATPAK_DEST}/lib -DCMAKE_INSTALL_DATAROOTDIR:PATH=${FLATPAK_DEST}/share
      .
    - python3 setup.py install --prefix=${FLATPAK_DEST}
    - cmake --build .
    - cmake --install .
  sources:
    - type: archive
      url: https://github.com/pybind/pybind11/archive/v2.9.0.tar.gz
      sha256: 057fb68dafd972bc13afb855f3b0d8cf0fa1a78ef053e815d9af79be7ff567cb

- name: lapack
  buildsystem: cmake
  builddir: true
  config-opts:
    - '-DCMAKE_BUILD_TYPE=Release'
    - '-DBUILD_SHARED_LIBS=ON'
    - '-DBUILD_TESTING=OFF'
    - '-DLAPACKE=ON'
    - '-DCBLAS=ON'
  sources:
    - type: archive
      url: http://www.netlib.org/lapack/lapack-3.8.0.tar.gz
      sha512: 17786cb7306fccdc9b4a242de7f64fc261ebe6a10b6ec55f519deb4cb673cb137e8742aa5698fd2dc52f1cd56d3bd116af3f593a01dcf6770c4dcc86c50b2a7f
  cleanup:
    - '/lib/cmake'

- name: python3-numpy
  buildsystem: simple
  build-commands:
    - python3 setup.py build -j6
    - python3 setup.py install --prefix=/app --root=/ --optimize=1
  build-options:
    env:
      ATLAS: None
      BLAS: "/app/lib"
      LAPACK: "/app/lib"
  cleanup:
    - "/bin"
  sources:
    - type: archive
      url: https://github.com/numpy/numpy/releases/download/v1.22.2/numpy-1.22.2.tar.gz
      sha256: 093d513a460fd94f94c16193c3ef29b2d69a33e482071e3d6d6e561a700587a6

# libzip is needed for tiscamera
- name: libzip
  buildsystem: cmake-ninja
  config-opts:
  - "-DCMAKE_BUILD_TYPE=Release"
  - "-DCMAKE_INSTALL_LIBDIR=lib"
  cleanup:
  - "/include"
  - "/bin"
  - "/share"
  - "/lib/pkgconfig"
  - "/lib/*.la"
  sources:
  - type: archive
    url: https://libzip.org/download/libzip-1.8.0.tar.xz
    sha256: f0763bda24ba947e80430be787c4b068d8b6aa6027a26a19923f0acfa3dac97e

- name: tiscamera
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
    - -DTCAM_INSTALL_UDEV=/app/lib/udev
    - -DTCAM_INSTALL_UVCDYNCTRL=/app/share/uvcdynctrl/data/199e
    - -DTCAM_INSTALL_SYSTEMD=/app/lib/systemd/system/
    - -DTCAM_BUILD_WITH_GUI=OFF
    - -DGOBJECT_INTROSPECTION_1.0_GIRDIR=/app/share/gir-1.0/
    - -DGOBJECT_INTROSPECTION_1.0_TYPELIBDIR=/app/lib/girepository-1.0
    - -DGSTREAMER_1.0_PLUGINSDIR=/app/lib/gstreamer-1.0
    - -DGSTREAMER_1.0_INCLUDEDIR=/include/gstreamer-1.0
  sources:
    - type: git
      url: https://github.com/TheImagingSource/tiscamera.git

- name: pomidaq
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
    - -DPYTHON=OFF
    - -DGUI=OFF
  sources:
    - type: git
      url: https://github.com/bothlab/pomidaq.git

- name: syntalos
  buildsystem: meson
  builddir: true
  config-opts:
    - -Doptimize-modern-amd64=true
    - -Dudevdir=/app/lib/udev
    - -Dmodules=miniscope,camera-tis,intan-rhx
  sources:
    - type: dir
      path: ../..
